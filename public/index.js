/**
 * CHG MEDICAL TOOLKIT - MAIN APPLICATION LOGIC
 * Version: 2.0 (Stable)
 * Features:
 * - Supabase Integration (Logs)
 * - Full Medical Calculators (Heparin, Padua, etc.)
 * - Reliable Notifications (In-App Timer + Calendar Backup)
 * - PWA Support
 */

// ==========================================
// SECTION 1: CONFIGURATION & CONSTANTS
// ==========================================
const SUPABASE_URL = 'https://kjiujbsyhxpooppmxgxb.supabase.co';
// ‚ö†Ô∏è ŸáÿßŸÖ: ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ∂ÿπ ŸÖŸÅÿ™ÿßÿ≠ anon ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸáŸÜÿß
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE'; 
const HISTORY_PASSWORD = 'CHG123';

// ==========================================
// SECTION 2: GLOBAL STATE & VARIABLES
// ==========================================
const appState = {
  currentView: 'dashboard',
  currentHeparinMode: 'initial',
  historyLogs: [],
  activeTimerInterval: null, // ŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖÿπÿ±ŸÅ ÿßŸÑÿπÿØÿßÿØ ÿßŸÑŸÜÿ¥ÿ∑
};

// DOM Elements Cache (ŸÑÿ™ÿ≥ÿ±Ÿäÿπ ÿßŸÑÿ£ÿØÿßÿ°)
let db;
let $;
let $$;
let ui = {}; // ÿ≥ŸÜÿÆÿ≤ŸÜ ŸÉŸÑ ÿπŸÜÿßÿµÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ© ŸáŸÜÿß ŸÑŸäŸÉŸàŸÜ ÿßŸÑŸÉŸàÿØ ŸÖŸÜÿ∏ŸÖÿßŸã

// ==========================================
// SECTION 3: UTILITY FUNCTIONS (HELPERS)
// ==========================================

/**
 * ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿπÿØ ŸÑÿ™ŸÇŸàŸäŸÖ ÿ¨Ÿàÿ¨ŸÑ
 */
function createCalendarLink(toolName, patientName, patientId, minutesFromNow) {
  const now = new Date();
  const targetTime = new Date(now.getTime() + minutesFromNow * 60000);
  const endTime = new Date(targetTime.getTime() + 15 * 60000); // ŸÖÿØÿ© 15 ÿØŸÇŸäŸÇÿ©

  const formatTime = (date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");
  
  const title = `CHG Alert: ${toolName} Check`;
  const details = `
üö® MEDICAL ALERT
------------------
Patient: ${patientName}
ID: ${patientId}
Task: ${toolName}
Action: Check PTT / Monitoring required.
------------------
Generated by CHG Toolkit`.trim();

  return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${formatTime(targetTime)}/${formatTime(endTime)}&details=${encodeURIComponent(details)}`;
}

/**
 * ÿ™ÿ¥ÿ∫ŸäŸÑ ÿπÿØÿßÿØ ÿ™ŸÜÿßÿ≤ŸÑŸä ŸÖÿ≠ŸÑŸä ÿØÿßÿÆŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
 */
function startLocalTimer(durationMinutes, displayElementId, patientName) {
  // 1. ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
  if ("Notification" in window && Notification.permission !== 'granted') {
    Notification.requestPermission();
  }

  // 2. ÿ•ŸäŸÇÿßŸÅ ÿ£Ÿä ÿπÿØÿßÿØ ÿ≥ÿßÿ®ŸÇ
  if (appState.activeTimerInterval) clearInterval(appState.activeTimerInterval);
  
  // 3. ÿ™ÿ¨ŸáŸäÿ≤ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿπÿØÿßÿØ
  const display = document.getElementById(displayElementId);
  const startBtn = display.parentElement.querySelector('.timer-start-btn');
  if(startBtn) startBtn.style.display = 'none';
  display.style.display = 'block';

  const endTime = new Date().getTime() + (durationMinutes * 60 * 1000);

  // 4. ÿ®ÿØÿ° ÿßŸÑÿπÿØ
  appState.activeTimerInterval = setInterval(() => {
    const now = new Date().getTime();
    const distance = endTime - now;

    if (distance < 0) {
      clearInterval(appState.activeTimerInterval);
      display.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded text-center font-bold animate-pulse">‚è∞ TIME'S UP! CHECK PTT NOW</div>`;
      playAlarmSound();
      showSystemNotification(patientName);
      return;
    }

    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    display.innerHTML = `
      <div class="text-center">
        <div class="text-3xl font-mono font-bold text-red-600">
          ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}
        </div>
        <div class="text-xs text-gray-500 mt-1">Keep app open or screen active</div>
      </div>
    `;
  }, 1000);
}

function playAlarmSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'square';
    osc.frequency.setValueAtTime(440, ctx.currentTime);
    osc.frequency.setValueAtTime(880, ctx.currentTime + 0.2);
    osc.frequency.setValueAtTime(440, ctx.currentTime + 0.4);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 1);
  } catch (e) { console.error('Audio error', e); }
}

function showSystemNotification(patientName) {
  if ("Notification" in window && Notification.permission === "granted") {
    new Notification("CHG Medical Alert", {
      body: `Time to check PTT for patient: ${patientName}`,
      icon: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhFzwIoH5I9Dg_dwbN_Kc4B2KdJiTjIVJIc45xnOQ28R2dw75hGSE97vmQpYfXKO1r0qAceEw2kpp78Y_aTgD6YCZfpZiMC8bStPrEDYzOUSUV96h9kYYcS5PD_nAltwlYEL1umN-Z6KjXfyIaFEU-OP4-Ldo6r1V9ZZwfp3AG1YDJYGoOsgWKNcoT3igc4/s192/bc19f2e5-04b9-441b-a4f4-ccf4fe8e8d31.png"
    });
  }
}

function formatDateTime(isoString) {
  try {
    return new Date(isoString).toLocaleString('en-US', {
      year: '2-digit', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', hour12: true
    });
  } catch (e) { return isoString; }
}

// ==========================================
// SECTION 4: NAVIGATION & UI LOGIC
// ==========================================
function navigateTo(viewId, title) {
  // 1. Update Views
  ui.allViews.forEach(view => view.classList.remove('active'));
  const target = $(`#${viewId}`);
  if (target) {
    target.classList.add('active');
    appState.currentView = viewId;
  }
  
  // 2. Update Header & Nav
  ui.appTitle.textContent = title;
  ui.headerBackButton.style.display = (viewId === 'view-dashboard') ? 'none' : 'block';
  
  ui.allNavButtons.forEach(btn => {
    const navId = btn.dataset.nav;
    // Logic: Home is active unless we are in History view
    let isActive = (navId === 'dashboard' && viewId !== 'view-history') || 
                   (navId === 'history' && viewId === 'view-history');
    btn.classList.toggle('active', isActive);
  });

  ui.appContent.scrollTop = 0;

  // 3. Special Case: History View
  if (viewId === 'view-history') {
    resetHistoryView();
  }
}

function resetHistoryView() {
  $('#history-logs-container').innerHTML = '';
  ui.historySearch.value = '';
  appState.historyLogs = [];
  ui.passwordPrompt.classList.remove('hidden');
  $('#password-input').value = '';
  $('#password-input').focus();
  const err = ui.passwordForm.querySelector('.error-box');
  if (err) err.remove();
}

function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', isDark);
}

// ==========================================
// SECTION 5: CALCULATORS LOGIC (THE CORE)
// ==========================================

// --- 5.1 Heparin Calculator ---
function calculateInitialHeparinRate(data) {
  const { weight, concentration, indication } = data;
  if (!weight || !concentration || !indication) return { error: 'Missing Data' };

  let loadUnits = 0, rateUnitsKg = 0;
  
  if (indication === 'AF') {
    loadUnits = Math.min(80 * weight, 5000); // Max 5000
    rateUnitsKg = 18;
  } else if (indication === 'Venous thromboembolism') {
    loadUnits = Math.min(80 * weight, 10000); // Max 10000
    rateUnitsKg = 18;
  } else if (indication === 'Acute coronary syndrome') {
    loadUnits = 70 * weight; // No Max specified usually, or max 4000? keeping as per original code
    rateUnitsKg = 18; // Original code used 18 for ACS
  }

  const loadMl = (loadUnits / concentration).toFixed(2);
  const rateMl = ((rateUnitsKg * weight) / concentration).toFixed(2);

  return {
    html: `
      <div class="result-box">
        <p class="result-title">Initial Dose (${indication})</p>
        <p class="mt-2">Loading Dose: <strong>${loadUnits.toFixed(0)} units (${loadMl} mL)</strong></p>
        <p class="mt-2">Infusion Rate: <strong>${rateMl} mL/hr</strong></p>
        <p class="mt-2 text-blue-600">Next PTT Check: <strong>in 6 hours</strong></p>
      </div>`,
    logData: { loading_dose: `${loadUnits}u`, initial_rate: `${rateMl}ml/hr` },
    alert: { title: "Heparin PTT Check", delay: 360 } // 6 hours
  };
}

function calculateMaintenanceHeparinRate(data) {
  const { weight, concentration, rate, ptt } = data;
  
  // Calculate current units per kg per hour
  const currentUnitsHr = rate * concentration;
  const currentUnitsKgHr = currentUnitsHr / weight;
  
  let newUnitsKgHr = currentUnitsKgHr;
  let bolus = 0;
  let stopMin = 0;
  let nextPtt = 6; // hours
  let msg = '';
  let boxClass = 'result-box';

  // Protocol Logic (Standard Heparin Protocol)
  if (ptt < 40) {
    bolus = 25 * weight; // 25 u/kg bolus
    newUnitsKgHr += 3;   // Increase by 3 u/kg/hr
    msg = 'PTT < 40: Low.';
    boxClass = 'error-box';
  } else if (ptt <= 49) {
    newUnitsKgHr += 2;
    msg = 'PTT 40-49: Low.';
    boxClass = 'error-box';
  } else if (ptt <= 69) {
    newUnitsKgHr += 1;
    msg = 'PTT 50-69: Slightly Low.';
    boxClass = 'error-box';
  } else if (ptt <= 110) {
    msg = 'PTT 70-110: Therapeutic Range. No Change.';
  } else if (ptt <= 120) {
    newUnitsKgHr -= 1;
    msg = 'PTT 111-120: High.';
    boxClass = 'error-box';
  } else if (ptt <= 130) {
    stopMin = 60; // Stop 1 hr
    newUnitsKgHr -= 2;
    msg = 'PTT 121-130: High. Stop infusion 60m.';
    boxClass = 'error-box';
  } else if (ptt <= 140) {
    stopMin = 60;
    newUnitsKgHr -= 3;
    msg = 'PTT 131-140: Very High. Stop infusion 60m.';
    boxClass = 'error-box';
  } else if (ptt <= 150) {
    stopMin = 120; // Stop 2 hr
    newUnitsKgHr -= 5;
    msg = 'PTT 141-150: Extremely High. Stop infusion 120m.';
    boxClass = 'error-box';
  } else {
    // > 150
    stopMin = 180; // Stop 3 hr (or per protocol)
    newUnitsKgHr = 0; // Usually hold and re-check, here we set to 0 to indicate HOLD
    nextPtt = 0; // Call MD
    msg = 'PTT > 150: Critical. Stop 180m & Call MD.';
    boxClass = 'error-box';
  }

  if (newUnitsKgHr < 0) newUnitsKgHr = 0;

  const newRateMl = ((newUnitsKgHr * weight) / concentration).toFixed(2);
  const bolusMl = (bolus / concentration).toFixed(2);
  let nextPttText = nextPtt > 0 ? `in ${nextPtt} hours` : "Per MD Order";

  let html = `<div class="${boxClass}"><p class="result-title">Maintenance Adjustment</p>`;
  if(bolus > 0) html += `<p class="mt-2 text-red-600 font-bold">Give Bolus: ${bolus.toFixed(0)} units (${bolusMl} mL)</p>`;
  if(stopMin > 0) html += `<p class="mt-2 text-red-600 font-bold">STOP Infusion for: ${stopMin} minutes</p>`;
  
  if (nextPtt > 0 && newUnitsKgHr > 0) {
     html += `<p class="mt-2">New Rate: <strong>${newRateMl} mL/hr</strong> <small>(${newUnitsKgHr.toFixed(1)} u/kg/hr)</small></p>`;
  } else if (newUnitsKgHr === 0 && stopMin === 0) {
     // If we just reduced to 0 without stop (unlikely but possible logic)
     html += `<p class="mt-2">Hold Infusion.</p>`;
  }

  html += `<p class="mt-2">Next PTT: <strong>${nextPttText}</strong></p>`;
  html += `<p class="text-sm mt-3 opacity-75 border-t pt-2">${msg}</p></div>`;

  // Determine Alert
  let alert = null;
  if (stopMin > 0) {
    alert = { title: "Restart Heparin", delay: stopMin };
  } else if (nextPtt > 0) {
    alert = { title: "Heparin PTT Check", delay: nextPtt * 60 };
  }

  return { html, logData: { new_rate: newRateMl, msg }, alert };
}

// --- 5.2 Prophylaxis Calculator ---
function calculateProphylaxis(factors) {
  const highRiskList = [
    'Mechanical Ventilation with no enteral feeding (>48h)', 'Chronic Liver Disease', 'Concerning Coagulopathy',
    'Multiple Trauma, Brain Injury or Spinal Cord', 'Burns over 35% of total surface area', 'Organ Transplant',
    'History of Peptic Ulcer Disease', 'Dual Antiplatelet', 'Septic Shock'
  ];
  const modRiskList = [
    'Mechanical Ventilation with enteral nutrition', 'Single Antiplatelet Therapy', 'Oral Anticoagulation', 'SepsIS',
    'ICU stay > 7 days', 'Renal Replacement Therapy', 'High Dose Steroids or Immunosuppressant', 'Shock'
  ];

  let highCount = factors.filter(f => highRiskList.includes(f)).length;
  let modCount = factors.filter(f => modRiskList.includes(f)).length;

  let risk = 'Low Risk';
  let indicated = false;

  if (highCount > 0) {
    risk = 'High Risk';
    indicated = true;
  } else if (modCount >= 2) {
    risk = 'Moderate Risk';
    indicated = true;
  }

  const color = indicated ? 'error-box' : 'result-box';
  const text = indicated ? 'Stress Ulcer Prophylaxis INDICATED' : 'Prophylaxis NOT Indicated';

  return {
    html: `<div class="${color}"><p class="result-title">${risk}</p><p class="font-bold text-lg">${text}</p></div>`,
    logData: { risk, indicated }
  };
}

// --- 5.3 Padua Score ---
function calculatePadua(score) {
  const risk = score >= 4 ? 'High Risk' : 'Low Risk';
  const color = score >= 4 ? 'error-box' : 'result-box';
  const msg = score >= 4 ? 'VTE Prophylaxis Recommended' : 'VTE Prophylaxis Not Required';

  return {
    html: `<div class="${color}"><p class="result-title">Score: ${score} (${risk})</p><p class="font-bold">${msg}</p></div>`,
    logData: { score, risk }
  };
}

// --- 5.4 IV Rate ---
function calculateIV(d) {
  // d = { weight, drugMg, volMl, dose, unit }
  const conc = d.drugMg / d.volMl; // mg/mL
  let rate = 0;

  if (d.unit === 'mcg/kg/min') {
    // (dose * kg * 60) / (conc * 1000)
    rate = (d.dose * d.weight * 60) / (conc * 1000);
  } else if (d.unit === 'mcg/min') {
    // (dose * 60) / (conc * 1000)
    rate = (d.dose * 60) / (conc * 1000);
  } else if (d.unit === 'mg/hr') {
    // dose / conc
    rate = d.dose / conc;
  }

  return {
    html: `<div class="result-box"><p class="text-center">Infusion Rate</p><p class="text-3xl font-bold text-center my-2">${rate.toFixed(1)} mL/hr</p></div>`,
    logData: { rate: rate.toFixed(1) }
  };
}

// --- 5.5 Renal (CrCl) ---
function calculateRenal(d) {
  // Cockcroft-Gault: ((140-age) * kg) / (72 * cr) (* 0.85 if female)
  let val = ((140 - d.age) * d.weight) / (72 * d.creatinine);
  if (d.gender === 'female') val *= 0.85;

  return {
    html: `<div class="result-box"><p class="text-center">Est. CrCl</p><p class="text-3xl font-bold text-center my-2">${val.toFixed(1)} mL/min</p><p class="text-xs text-center opacity-60">Cockcroft-Gault Equation</p></div>`,
    logData: { crcl: val.toFixed(1) }
  };
}

// --- 5.6 Converter ---
function doConversion(val, from, to) {
  // Simple Logic for demo, can be expanded
  const masses = {kg: 1000000, g: 1000, mg: 1, mcg: 0.001};
  if (masses[from] && masses[to]) {
    // convert to mg then to target
    const inMg = val * masses[from];
    return inMg / masses[to];
  }
  if (from === 'lbs_kg' && to === 'kg_lbs') return val * 0.453592; // lbs to kg
  if (from === 'kg_lbs' && to === 'lbs_kg') return val * 2.20462; // kg to lbs
  return val; // Fallback
}


// ==========================================
// SECTION 6: EVENT HANDLERS
// ==========================================

// --- 6.1 Heparin Handlers ---
async function handleHeparinSubmit(e) {
  e.preventDefault();
  const btn = $('#heparin-calculate-btn');
  const resDiv = $('#heparin-result-area');
  
  btn.disabled = true;
  btn.querySelector('span').textContent = 'Processing...';
  resDiv.innerHTML = '';

  try {
    const common = {
      patientName: $('#heparin-patientName').value,
      patientId: $('#heparin-patientIdentifier').value,
      weight: parseFloat($('#heparin-weight').value),
      concentration: parseFloat($('#heparin-concentration').value),
    };

    if(!common.patientName || !common.patientId) throw new Error("Patient details required");

    let result;
    if (appState.currentHeparinMode === 'initial') {
      result = calculateInitialHeparinRate({
        ...common,
        indication: $('#heparin-indication').value
      });
    } else {
      result = calculateMaintenanceHeparinRate({
        ...common,
        rate: parseFloat($('#heparin-currentRate').value),
        ptt: parseFloat($('#heparin-currentPtt').value)
      });
    }

    // Render Result
    let html = result.html;
    
    // Add Timer & Calendar if alert exists
    if (result.alert) {
      const timerId = `timer-${Date.now()}`;
      const calLink = createCalendarLink("Heparin", common.patientName, common.patientId, result.alert.delay);
      const hrs = (result.alert.delay / 60).toFixed(1);

      html += `
        <div class="mt-4 pt-4 border-t border-gray-200">
          <button type="button" class="btn timer-start-btn w-full mb-2 bg-red-600 hover:bg-red-700 text-white"
            onclick="window.startLocalTimer(${result.alert.delay}, '${timerId}', '${common.patientName}')">
            ‚è∞ Start ${hrs} Hour Timer
          </button>
          
          <div id="${timerId}" style="display:none;" class="mb-2"></div>
          
          <a href="${calLink}" target="_blank" class="block w-full text-center py-2 text-blue-600 font-semibold text-sm hover:underline">
            üìÖ Add Backup Reminder to Calendar
          </a>
        </div>
      `;
    }

    resDiv.innerHTML = html;
    
    // Save to DB
    await saveLog(appState.currentHeparinMode, common.patientName, common.patientId, common, result.logData);

  } catch (err) {
    resDiv.innerHTML = `<div class="error-box">${err.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.querySelector('span').textContent = 'Calculate';
  }
}

// --- 6.2 Prophylaxis Handlers ---
async function handleProphylaxisSubmit(e) {
  e.preventDefault();
  const resDiv = $('#prophylaxis-result-area');
  const btn = $('#prophylaxis-save-btn');
  const checks = Array.from(ui.prophylaxisForm.querySelectorAll('input:checked')).map(c => c.value);

  btn.disabled = true; btn.textContent = 'Saving...';
  
  try {
    const result = calculateProphylaxis(checks);
    const pName = $('#prophylaxis-patientName').value;
    const pId = $('#prophylaxis-patientIdentifier').value;
    if(!pName || !pId) throw new Error("Patient details required");

    resDiv.innerHTML = result.html;
    await saveLog('prophylaxis', pName, pId, { factors: checks }, result.logData);
    btn.textContent = 'Saved!';
  } catch (err) {
    resDiv.innerHTML = `<div class="error-box">${err.message}</div>`;
    btn.textContent = 'Save Result';
  } finally {
    setTimeout(() => { btn.disabled = false; btn.textContent = 'Save Result'; }, 2000);
  }
}

// --- 6.3 Padua Handlers ---
async function handlePaduaSubmit(e) {
  e.preventDefault();
  const resDiv = $('#padua-result-area');
  const btn = $('#padua-save-btn');
  
  let score = 0;
  const factors = [];
  ui.paduaForm.querySelectorAll('input:checked').forEach(c => {
    score += parseInt(c.dataset.score);
    factors.push(c.value);
  });

  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    const result = calculatePadua(score);
    const pName = $('#padua-patientName').value;
    const pId = $('#padua-patientIdentifier').value;
    
    resDiv.innerHTML = result.html;
    await saveLog('padua', pName, pId, { factors, score }, result.logData);
    btn.textContent = 'Saved!';
  } catch (err) {
    resDiv.innerHTML = `<div class="error-box">Error saving</div>`;
  } finally {
    setTimeout(() => { btn.disabled = false; btn.textContent = 'Save Score'; }, 2000);
  }
}

// --- 6.4 IV & Renal Handlers ---
function handleIVSubmit(e) {
  e.preventDefault();
  const resDiv = $('#iv-result-area');
  try {
    const d = {
      weight: parseFloat($('#iv-weight').value),
      drugMg: parseFloat($('#iv-drugAmount').value),
      volMl: parseFloat($('#iv-solutionVolume').value),
      dose: parseFloat($('#iv-drugDose').value),
      unit: $('#iv-doseUnit').value
    };
    const result = calculateIV(d);
    resDiv.innerHTML = result.html;
    // Auto-save IV? Optional. Let's save if patient name exists
    const pName = $('#iv-patientName').value;
    if(pName) saveLog('iv_calc', pName, $('#iv-patientIdentifier').value, d, result.logData);
  } catch(err) { resDiv.innerHTML = `<div class="error-box">Check inputs</div>`; }
}

function handleRenalInput() {
  const d = {
    age: parseFloat($('#renal-age').value),
    weight: parseFloat($('#renal-weight').value),
    creatinine: parseFloat($('#renal-creatinine').value),
    gender: $('#renal-gender').value
  };
  if(d.age && d.weight && d.creatinine) {
    $('#renal-result-area').innerHTML = calculateRenal(d).html;
  }
}

// --- 6.5 History & Password ---
function handlePasswordSubmit(e) {
  e.preventDefault();
  if ($('#password-input').value === HISTORY_PASSWORD) {
    ui.passwordPrompt.classList.add('hidden');
    loadHistory();
  } else {
    alert("Incorrect Password");
  }
}

async function loadHistory() {
  const div = $('#history-logs-container');
  div.innerHTML = '<p class="text-center mt-8">Loading logs...</p>';
  
  const { data, error } = await db.from('calculation_logs').select('*').order('created_at', {ascending: false}).limit(50);
  
  if (error || !data.length) {
    div.innerHTML = '<p class="text-center mt-8 text-gray-500">No logs found.</p>';
    return;
  }
  
  appState.historyLogs = data;
  renderLogs(data);
}

function renderLogs(logs) {
  const div = $('#history-logs-container');
  div.innerHTML = logs.map(l => `
    <div class="log-entry">
      <div class="flex justify-between mb-2">
        <span class="font-bold text-teal-700 capitalize">${l.tool_name.replace(/_/g, ' ')}</span>
        <span class="text-xs text-gray-500">${formatDateTime(l.created_at)}</span>
      </div>
      <p class="text-sm font-semibold mb-2">${l.patient_name} (ID: ${l.patient_identifier})</p>
      <div class="text-sm bg-gray-50 p-2 rounded border">
        Result: ${JSON.stringify(l.result)}
      </div>
    </div>
  `).join('');
}

// ==========================================
// SECTION 7: DATABASE & INIT
// ==========================================
async function saveLog(tool, pName, pId, inputs, result) {
  if(!db) return;
  await db.from('calculation_logs').insert({
    tool_name: tool,
    patient_name: pName,
    patient_identifier: pId,
    inputs: inputs,
    result: result
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // 1. Initialize Globals
  $ = (s) => document.querySelector(s);
  $$ = (s) => document.querySelectorAll(s);
  
  // 2. Initialize UI Cache
  ui = {
    appTitle: $('#app-title'),
    appContent: $('.app-content'),
    headerBackButton: $('#header-back-button'),
    allViews: $$('.view'),
    allNavButtons: $$('.nav-button'),
    passwordPrompt: $('#password-prompt'),
    passwordForm: $('#password-form'),
    heparinForm: $('#heparin-form'),
    prophylaxisForm: $('#prophylaxis-form'),
    paduaForm: $('#padua-form'),
    historySearch: $('#history-search'),
    // ... add others as needed
  };

  // 3. Initialize DB
  try {
    const { createClient } = supabase;
    db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch(e) { console.error("Supabase Error", e); }

  // 4. Expose Global Functions
  window.startLocalTimer = startLocalTimer;

  // 5. Register Service Worker (PWA)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }

  // 6. Bind Events
  $('#nav-home').onclick = () => navigateTo('view-dashboard', 'CHG Toolkit');
  $('#nav-history').onclick = () => navigateTo('view-history', 'History');
  ui.headerBackButton.onclick = () => navigateTo('view-dashboard', 'CHG Toolkit');
  
  $('#dark-mode-toggle').onclick = toggleDarkMode;
  
  $$('.tool-card').forEach(c => c.onclick = () => {
    navigateTo(`view-${c.dataset.nav}`, c.querySelector('.tool-card-title').innerText.replace('<br>', ' '));
  });

  // Mode Toggles
  $('#heparin-mode-initial').onclick = () => {
    appState.currentHeparinMode = 'initial';
    $('#heparin-initial-fields').classList.remove('hidden');
    $('#heparin-maintenance-fields').classList.add('hidden');
    $('#heparin-mode-initial').classList.add('active');
    $('#heparin-mode-maintenance').classList.remove('active');
  };
  $('#heparin-mode-maintenance').onclick = () => {
    appState.currentHeparinMode = 'maintenance';
    $('#heparin-initial-fields').classList.add('hidden');
    $('#heparin-maintenance-fields').classList.remove('hidden');
    $('#heparin-mode-maintenance').classList.add('active');
    $('#heparin-mode-initial').classList.remove('active');
  };

  // Forms
  ui.heparinForm.onsubmit = handleHeparinSubmit;
  ui.prophylaxisForm.onsubmit = handleProphylaxisSubmit;
  ui.paduaForm.onsubmit = handlePaduaSubmit;
  $('#iv-form').onsubmit = handleIVSubmit;
  ui.passwordForm.onsubmit = handlePasswordSubmit;
  
  // Realtime Inputs
  $('#renal-form').oninput = handleRenalInput;
  $('#converter-form').oninput = () => {
    const val = parseFloat($('#converter-fromValue').value);
    const res = doConversion(val, $('#converter-fromUnit').value, $('#converter-toUnit').value);
    $('#converter-toValue').value = res;
  };
  
  ui.historySearch.oninput = (e) => {
    const term = e.target.value.toLowerCase();
    renderLogs(appState.historyLogs.filter(l => l.patient_name.toLowerCase().includes(term)));
  };

  // 7. Start
  const savedMode = localStorage.getItem('darkMode');
  if (savedMode === 'true') document.body.classList.add('dark');
  navigateTo('view-dashboard', 'CHG Toolkit');
});
